"use strict";var e=require("apipost-tools"),t=require("lodash"),r=require("uuid");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=i(e),o=["类型","Array","Boolean","Date","Function","NaN","Number","Integer","Object","RegExp","String","Undefined","File"],l=function(e){var r="Any",i={Array:t.isArray,Boolean:t.isBoolean,Date:t.isDate,Function:t.isFunction,NaN:isNaN,Number:t.isNumber,Integer:t.isInteger,Object:t.isObject,RegExp:t.isRegExp,String:t.isString,Undefined:t.isUndefined,Null:t.isNull};return o.forEach((function(t){i.hasOwnProperty(t)&&i[t](e)&&(r=t)})),r},a={none:"none","multipart/form-data":"form-data","application/x-www-form-urlencoded":"urlencoded","application/json":"json","application/xml":"xml","application/javascript":"javascript","text/plain":"plain","text/html":"html"},s=function(){return s=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},s.apply(this,arguments)},u={kv:{key:"",value:""},bearer:{key:""},basic:{username:"",password:""},digest:{username:"",password:"",realm:"",nonce:"",algorithm:"",qop:"",nc:"",cnonce:"",opaque:""},hawk:{authId:"",authKey:"",algorithm:"",user:"",nonce:"",extraData:"",app:"",delegation:"",timestamp:"",includePayloadHash:-1},awsv4:{accessKey:"",secretKey:"",region:"",service:"",sessionToken:"",addAuthDataToQuery:-1},ntlm:{username:"",password:"",domain:"",workstation:"",disableRetryRequest:1},edgegrid:{accessToken:"",clientToken:"",clientSecret:"",nonce:"",timestamp:"",baseURi:"",headersToSign:""},oauth1:{consumerKey:"",consumerSecret:"",signatureMethod:"",addEmptyParamsToSign:-1,includeBodyHash:-1,addParamsToHeader:-1,realm:"",version:"1.0",nonce:"",timestamp:"",verifier:"",callback:"",tokenSecret:"",token:""}},d=function(e){var r,i,n,o,l,a,d,v,c,p,y,h,m,g,f,q,k,w,O,b,S,_,P,j,A,T,x,D,N,R,J,E,C,I,U,F,K,H,B,L,M,Q,G,V,W,X,$,z,Y,Z,ee,te,re,ie,ne,oe,le,ae,se,ue,de,ve,ce,pe,ye,he,me,ge={target_type:(null==e?void 0:e.target_type)||"api",name:(null==e?void 0:e.name)||"",mark:(null==e?void 0:e.mark)||"developing"};switch(ge.target_type){case"api":var fe={method:(null==e?void 0:e.method)||"POST",mock:(null==e?void 0:e.mock)||"{}",mock_url:(null==e?void 0:e.mock_url)||"",request:{url:(null===(n=null==e?void 0:e.request)||void 0===n?void 0:n.url)||"",description:(null===(o=null==e?void 0:e.request)||void 0===o?void 0:o.description)||"",event:(null===(l=null==e?void 0:e.request)||void 0===l?void 0:l.event)||{}},response:(null==e?void 0:e.response)||{}};ge=s(s({},ge),fe),t.isPlainObject(null===(a=null==e?void 0:e.reuqest)||void 0===a?void 0:a.auth)&&t.isString(null===(v=null===(d=null==e?void 0:e.reuqest)||void 0===d?void 0:d.auth)||void 0===v?void 0:v.type)&&u.hasOwnProperty(e.reuqest.auth.type)&&e.reuqest.auth.hasOwnProperty(e.reuqest.auth.type)&&(ge.request.auth=((r={type:e.reuqest.auth.type})[e.reuqest.auth.type]=s(s({},u[e.reuqest.auth.type]),e.reuqest.auth[e.reuqest.auth.type]),r)),t.isPlainObject(null===(c=null==e?void 0:e.request)||void 0===c?void 0:c.body)&&t.isString(null===(y=null===(p=null==e?void 0:e.request)||void 0===p?void 0:p.body)||void 0===y?void 0:y.mode)&&"none"!==(null===(m=null===(h=null==e?void 0:e.request)||void 0===h?void 0:h.body)||void 0===m?void 0:m.mode)&&(ge.request.body=null===(g=null==e?void 0:e.request)||void 0===g?void 0:g.body),t.isArray(null===(q=null===(f=null==e?void 0:e.request)||void 0===f?void 0:f.header)||void 0===q?void 0:q.parameter)&&(null===(w=null===(k=null==e?void 0:e.request)||void 0===k?void 0:k.header)||void 0===w?void 0:w.parameter.length)>0&&(ge.request.header=null===(O=null==e?void 0:e.request)||void 0===O?void 0:O.header),t.isArray(null===(S=null===(b=null==e?void 0:e.request)||void 0===b?void 0:b.query)||void 0===S?void 0:S.parameter)&&(null===(P=null===(_=null==e?void 0:e.request)||void 0===_?void 0:_.query)||void 0===P?void 0:P.parameter.length)>0&&(ge.request.query=null===(j=null==e?void 0:e.request)||void 0===j?void 0:j.query),t.isArray(null===(T=null===(A=null==e?void 0:e.request)||void 0===A?void 0:A.resful)||void 0===T?void 0:T.parameter)&&(null===(D=null===(x=null==e?void 0:e.request)||void 0===x?void 0:x.resful)||void 0===D?void 0:D.parameter.length)>0&&(ge.request.resful=null===(N=null==e?void 0:e.request)||void 0===N?void 0:N.resful),t.isPlainObject(null===(R=null==e?void 0:e.request)||void 0===R?void 0:R.event)&&(t.isString(null===(J=null==e?void 0:e.script)||void 0===J?void 0:J.pre_script)&&(null===(E=e.request.event)||void 0===E?void 0:E.pre_script.length)>0||t.isString(null===(C=e.request.event)||void 0===C?void 0:C.test)&&(null===(I=e.request.event)||void 0===I?void 0:I.test.length)>0)&&(ge.request.event=null===(U=null==e?void 0:e.request)||void 0===U?void 0:U.event);break;case"folder":var qe={request:{description:(null===(F=null==e?void 0:e.request)||void 0===F?void 0:F.description)||""}};t.isPlainObject(null==e?void 0:e.script)&&(t.isString(null===(K=null==e?void 0:e.script)||void 0===K?void 0:K.pre_script)&&(null===(H=null==e?void 0:e.script)||void 0===H?void 0:H.pre_script.length)>0||t.isString(null===(B=null==e?void 0:e.script)||void 0===B?void 0:B.test)&&(null===(L=null==e?void 0:e.script)||void 0===L?void 0:L.test.length)>0)&&(qe.script=null===(M=null==e?void 0:e.request)||void 0===M?void 0:M.event),t.isArray(null===(Q=null==e?void 0:e.request)||void 0===Q?void 0:Q.body)&&(null===(G=null==e?void 0:e.request)||void 0===G?void 0:G.body.length)>0&&(qe.request.body=null===(V=null==e?void 0:e.request)||void 0===V?void 0:V.body),t.isArray(null===(W=null==e?void 0:e.request)||void 0===W?void 0:W.header)&&(null===(X=null==e?void 0:e.request)||void 0===X?void 0:X.header.length)>0&&(qe.request.header=null===($=null==e?void 0:e.request)||void 0===$?void 0:$.header),t.isArray(null===(z=null==e?void 0:e.request)||void 0===z?void 0:z.query)&&(null===(Y=null==e?void 0:e.request)||void 0===Y?void 0:Y.query.length)>0&&(qe.request.query=null===(Z=null==e?void 0:e.request)||void 0===Z?void 0:Z.query),t.isPlainObject(null===(ee=null==e?void 0:e.reuqest)||void 0===ee?void 0:ee.auth)&&t.isString(null===(re=null===(te=null==e?void 0:e.reuqest)||void 0===te?void 0:te.auth)||void 0===re?void 0:re.type)&&u.hasOwnProperty(e.reuqest.auth.type)&&e.reuqest.auth.hasOwnProperty(e.reuqest.auth.type)&&(qe.request.auth=((i={type:e.reuqest.auth.type})[e.reuqest.auth.type]=s(s({},u[e.reuqest.auth.type]),e.reuqest.auth[e.reuqest.auth.type]),i)),ge=s(s({},ge),qe);break;case"doc":var ke={request:{description:(null===(ie=null==e?void 0:e.request)||void 0===ie?void 0:ie.description)||""}};ge=s(s({},ge),ke);break;case"grpc":var we={protos:(null==e?void 0:e.protos)||{},request:{description:(null===(ne=null==e?void 0:e.request)||void 0===ne?void 0:ne.description)||""}};ge=s(s({},ge),we);break;case"websocket":var Oe={method:(null==e?void 0:e.method)||"Raw",request:{url:(null===(oe=null==e?void 0:e.request)||void 0===oe?void 0:oe.url)||"",description:(null===(le=null==e?void 0:e.request)||void 0===le?void 0:le.description)||""},message:(null==e?void 0:e.message)||"",messageType:(null==e?void 0:e.messageType)||"Text"};t.isArray(null===(se=null===(ae=null==e?void 0:e.request)||void 0===ae?void 0:ae.query)||void 0===se?void 0:se.parameter)&&(null===(de=null===(ue=null==e?void 0:e.request)||void 0===ue?void 0:ue.query)||void 0===de?void 0:de.parameter.length)>0&&(Oe.request.query=null===(ve=null==e?void 0:e.request)||void 0===ve?void 0:ve.query),t.isArray(null===(pe=null===(ce=null==e?void 0:e.request)||void 0===ce?void 0:ce.header)||void 0===pe?void 0:pe.parameter)&&(null===(he=null===(ye=null==e?void 0:e.request)||void 0===ye?void 0:ye.header)||void 0===he?void 0:he.parameter.length)>0&&(Oe.request.header=null===(me=null==e?void 0:e.request)||void 0===me?void 0:me.header),t.isPlainObject(null==e?void 0:e.socketConfig)&&(Oe.socketConfig=null==e?void 0:e.socketConfig),ge=s(s({},ge),Oe)}return ge},v=function(e,r){t.isArray(r)&&r.length>0&&(e.apis=function(e,t,r){void 0===t&&(t="id"),void 0===r&&(r="pid");try{for(var i=[],n={},o=0,l=e;o<l.length;o++){var a=l[o],u=a[t],v=a[r];if(u&&null!=u){n.hasOwnProperty(u)||(n[u]={children:[]}),n[u]=s(s({},d(a)),{children:n[u].children});var c=n[u];0==v||null==v?i.push(c):(n.hasOwnProperty(v)||(n[v]={children:[]}),n[v].children.push(c))}}return i}catch(e){return[]}}(r,"target_id","parent_id")||[])},c={import2array:function(e,r){void 0===r&&(r="");var i,a=[];if(n.default.isJson(e))if((i=JSON.parse(e))instanceof Array)for(var s=0,u=i;s<u.length;s++){var d=u[s];if(d.hasOwnProperty("key")&&d.key&&"undefined"!=d.key){h=(null==d?void 0:d.value)||"";t.isObject(h)&&(h=JSON.stringify(h)),a.push({description:(null==d?void 0:d.description)||"",is_checked:d.hasOwnProperty("is_checked")&&0==d.is_checked?0:1,key:(null==d?void 0:d.key)||"",type:d.hasOwnProperty("type")&&"File"==d.type?"File":"Text",not_null:d.hasOwnProperty("not_null")&&-1==d.not_null?-1:1,field_type:(null==d?void 0:d.field_type)&&o.includes(d.field_type)?d.field_type:l(h)||"Text",value:"query"==r?encodeURIComponent(String(h)||""):String(h)||""})}}else for(var v in i){h=i[v]||"";t.isObject(h)&&(h=JSON.stringify(h)),v&&""!=v&&a.push({description:"",is_checked:1,key:String(v),type:"Text",not_null:1,field_type:l(h)||"Text",value:"query"==r?encodeURIComponent(String(h)):String(h)})}else for(var c in i=e.split(/((\r\n)|[\r\n])+/gi))if("string"==typeof i[c]&&i[c].length>0){var p=i[c].indexOf(":"),y=i[c].split(":"),v="".concat(y[0]).trim(),h="".concat(i[c].substr(p+1)).trim();n.default.isJson(h)&&(h=JSON.stringify(h)),v&&v.length>0&&a.push({description:"",is_checked:1,key:v,type:"Text",not_null:1,field_type:l(h)||"Text",value:"query"==r?encodeURIComponent(h):h})}return a},export2str:function(e,t){void 0===t&&(t="key-value");try{var r=[],i={},n="";if(e instanceof Array)switch(t){case"json":e.forEach((function(e){e.hasOwnProperty("key")&&e.key&&(i[String(e.key)]=String((null==e?void 0:e.value)||""))})),n=JSON.stringify(i,null,"\t");break;case"json-desc":r=e.filter((function(e){return e.hasOwnProperty("key")&&e.key})),n=JSON.stringify(r,null,"\t");break;case"key-value":e.forEach((function(e){e.hasOwnProperty("key")&&e.key&&(n+="".concat(e.key,":").concat((null==e?void 0:e.value)||"","\n"))}))}return n}catch(e){return""}},importdesc2array:function(e,r){var i,o=[];if(n.default.isJson(e))if((i=JSON.parse(e))instanceof Array);else for(var l in i){d=i[l]||"";t.isObject(d)&&(d=JSON.stringify(d)),l&&""!=l&&o.push({description:String(d),key:l})}else for(var a in i=e.split(/((\r\n)|[\r\n])+/gi))if("string"==typeof i[a]&&i[a].length>0){var s=i[a].indexOf(":"),u=i[a].split(":"),l="".concat(u[0]).trim(),d="".concat(i[a].substr(s+1)).trim();n.default.isJson(d)&&(d=JSON.stringify(d)),l&&l.length>0&&o.push({key:l,description:d})}return o},exportdesc2str:function(e,t){void 0===t&&(t="key-value");try{var r={},i="";if(e instanceof Array)switch(t){case"json":e.forEach((function(e){e.hasOwnProperty("key")&&e.key&&(r[String(e.key)]=String((null==e?void 0:e.description)||""))})),i=JSON.stringify(r,null,"\t");break;case"key-value":e.forEach((function(e){e.hasOwnProperty("key")&&e.key&&(i+="".concat(e.key,":").concat((null==e?void 0:e.description)||"","\n"))}))}return i}catch(e){return""}},objectArr2uniqueArr:function(e){var t=[],r={};if(e instanceof Array)for(var i=0;i<e.length;i++){var n=Object.keys(e[i]);n.sort((function(e,t){return Number(e)-Number(t)}));for(var o="",l=0;l<n.length;l++)o+=JSON.stringify(n[l]),o+=JSON.stringify(e[i][n[l]]);r.hasOwnProperty(o)||(t.push(e[i]),r[o]=!0)}return t},har2apipost:function(e){var t;try{var i={name:"新建接口",request:{auth:{type:"noauth",kv:{key:"",value:""},bearer:{key:""},basic:{username:"",password:""},digest:{username:"",password:"",realm:"",nonce:"",algorithm:"",qop:"",nc:"",cnonce:"",opaque:""},hawk:{authId:"",authKey:"",algorithm:"",user:"",nonce:"",extraData:"",app:"",delegation:"",timestamp:"",includePayloadHash:-1},awsv4:{accessKey:"",secretKey:"",region:"",service:"",sessionToken:"",addAuthDataToQuery:-1},ntlm:{username:"",password:"",domain:"",workstation:"",disableRetryRequest:1},edgegrid:{accessToken:"",clientToken:"",clientSecret:"",nonce:"",timestamp:"",baseURi:"",headersToSign:""},oauth1:{consumerKey:"",consumerSecret:"",signatureMethod:"",addEmptyParamsToSign:-1,includeBodyHash:-1,addParamsToHeader:-1,realm:"",version:"1.0",nonce:"",timestamp:"",verifier:"",callback:"",tokenSecret:"",token:""}},body:{mode:"none",parameter:[],raw:"",raw_para:[]},cookie:{parameter:[]},description:(null==e?void 0:e.comment)||"",event:{pre_script:"",test:""},header:{parameter:[]},query:{parameter:[]},resful:{parameter:[]},url:(null==e?void 0:e.url)||""},update_day:parseInt(String(new Date((new Date).toLocaleDateString()).getTime()/1e3),10),update_dtime:Date.parse(String(new Date))/1e3,create_dtime:Date.parse(String(new Date))/1e3,is_changed:-1,mark:"developing",method:(null==e?void 0:e.method)||"GET",parent_id:"0",project_id:"-1",sort:-1,target_id:r.v4(),type_sort:"1",version:1,target_type:"api",response:{success:{parameter:[],raw:""},error:{parameter:[],raw:""}},mock:"{}",mock_url:"",url:(null==e?void 0:e.url)||""},n=i.request;if(e.hasOwnProperty("headers")&&e.headers instanceof Array)for(var o=0,l=e.headers;o<l.length;o++){var s=l[o];(null==s?void 0:s.name)&&n.header.parameter.push({is_checked:"1",type:"Text",key:(null==s?void 0:s.name)||"",value:(null==s?void 0:s.value)||"",not_null:"1",description:(null==s?void 0:s.comment)||"",field_type:"Text"})}if(e.hasOwnProperty("queryString")&&e.queryString instanceof Array)for(var u=0,d=e.queryString;u<d.length;u++){var v=d[u];(null==v?void 0:v.name)&&n.query.parameter.push({is_checked:"1",type:"Text",key:(null==v?void 0:v.name)||"",value:(null==v?void 0:v.value)||"",not_null:"1",description:(null==v?void 0:v.comment)||"",field_type:"Text"})}if(e.hasOwnProperty("postData")&&e.postData instanceof Object&&e.postData.hasOwnProperty("mimeType")){var c=a[e.postData.mimeType]||"none";if(n.body.mode=c,n.body.raw=(null===(t=e.postData)||void 0===t?void 0:t.text)||"",e.postData.hasOwnProperty("params")&&e.postData.params instanceof Array)for(var p=0,y=e.postData.params;p<y.length;p++){var h=y[p];(null==h?void 0:h.name)&&n.body.parameter.push({is_checked:"1",type:h.hasOwnProperty("fileName")?"File":"Text",key:(null==h?void 0:h.name)||(null==h?void 0:h.fileName)||"",value:(null==h?void 0:h.value)||(null==h?void 0:h.fileName)||"",not_null:"1",description:(null==h?void 0:h.comment)||"",field_type:"Text"})}}return i}catch(e){return!1}},isElectron:function(){return!!(window&&window.process&&window.process.versions&&window.process.versions.electron)},setCookie:function(e,t,r,i){var n=new Date,o="";i?(n.setDate(n.getDate()+i),o=n.toUTCString()):o="",document.cookie="".concat(e,"=").concat(escape(t),";Path=/;").concat(r&&"Domain=.".concat(r)).concat(o&&";expiredays=".concat(o))},getCookie:function(e){for(var t=encodeURIComponent(e),r="(^| )".concat(t,"=([^;]*)(;|$)"),i=new RegExp(r),n="",o=document.cookie.split("; "),l=0;l<o.length;l++){var a=o[l].split("=");if(a[0]==e&&a[1].length>0)return a[1]}if(document&&document.hasOwnProperty("cookie")){var s=document.cookie.match(i);s&&(null==s?void 0:s.length)>2&&(n=s[2])}return n},ConvertResult:function(e,t,r){return{status:e,message:t,data:r}},getCachePath:function(){var e=process.env.TMPDIR;return e||(e=process.env.LOCALAPPDATA),e||(e=process.env.HOME),e||(e=process.env.PWD),e},isXml:function(e){return"html"!==(new DOMParser).parseFromString(e,"text/xml").documentElement.nodeName&&"<"===e.substring(0,1)&&">"===e.charAt(e.length-1)},apipost2exportApipost:function(e){var r={project:{},apis:[],envs:[]};try{var i=e||{},o=i.project,l=i.apis,a=i.envs;!function(e,r){var i,n=r||{},o=n.name,l=n.description,a=n.detatils||{},d=a.script,v=a.request,c=a.markList,p=a.globalDescriptionVars,y=v||{},h=y.query,m=y.header,g=y.body,f=y.auth;e.project.name=o||"新建项目",e.project.description=l||"",e.project.detatils={},t.isArray(p)&&(e.project.detatils.variable=p),t.isArray(c)&&(e.project.detatils.markList=c),t.isPlainObject(d)&&(e.project.detatils.script={},t.isString(null==d?void 0:d.pre_script)&&(e.project.detatils.script.pre_script=d.pre_script),t.isString(null==d?void 0:d.test)&&(e.project.detatils.script.test=d.test));var q={};t.isArray(h)&&(q.query=h),t.isArray(m)&&(q.header=m),t.isArray(g)&&(q.body=g),t.isPlainObject(f)&&t.isString(null==f?void 0:f.type)&&u.hasOwnProperty(f.type)&&f.hasOwnProperty(f.type)&&(q.auth=((i={type:f.type})[f.type]=s(s({},u[f.type]),f[f.type]),i)),t.isEmpty(q)||(e.project.detatils.request=q)}(r,o),v(r,l),function(e,r){t.isArray(r)&&r.length>0&&(e.envs=r.map((function(e){return{env_id:(null==e?void 0:e.env_id)||"",list:t.isPlainObject(null==e?void 0:e.list)?null==e?void 0:e.list:{},name:(null==e?void 0:e.name)||"新建环境",pre_url:(null==e?void 0:e.pre_url)||""}})))}(r,a);var d=n.default.successResult(r);return console.log("apipost2exportApipost",JSON.stringify(d,null,"\t")),d}catch(e){n.default.errorResult(String(e))}}};module.exports=c;
